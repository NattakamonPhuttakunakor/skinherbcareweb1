from flask import Flask, request, jsonify
from flask_cors import CORS
import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from pythainlp.tokenize import word_tokenize
from pythainlp.corpus import thai_stopwords
import sys
import os

app = Flask(__name__)
CORS(app)

# --- 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏™‡πà Try/Except ‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á) ---
df = None
try:
    # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå data.xlsx ‡∏´‡∏£‡∏∑‡∏≠ csv
    possible_files = ["data.xlsx", "data.csv"]
    for f in possible_files:
        if os.path.exists(f):
            if f.endswith('.csv'): df = pd.read_csv(f)
            else: df = pd.read_excel(f)
            print(f"‚úÖ Loaded file: {f}")
            break
except Exception as e:
    print(f"‚ö†Ô∏è Error loading file: {e}")

# ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ó‡∏ô (‡∏Å‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏°)
if df is None:
    print("‚ö†Ô∏è Using Dummy Data")
    data = {
        '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ': ['‡∏™‡∏¥‡∏ß‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö', '‡∏ú‡∏∑‡πà‡∏ô‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏û‡πâ'],
        '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å': ['‡∏ï‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á ‡πÄ‡∏à‡πá‡∏ö', '‡∏Ñ‡∏±‡∏ô ‡∏ú‡∏∑‡πà‡∏ô‡πÅ‡∏î‡∏á'],
        '‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏ï‡πâ‡∏ô': ['‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î', '‡∏ó‡∏≤‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏û‡πâ'],
        '‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á': ['‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô', '‡∏ß‡πà‡∏≤‡∏ô‡∏´‡∏≤‡∏á‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ']
    }
    df = pd.DataFrame(data)

# ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° AI
df.columns = df.columns.str.strip()
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î)
df['search_text'] = df.apply(lambda x: f"{x.get('‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ','')} {x.get('‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å','')}", axis=1)

vectorizer = TfidfVectorizer(tokenizer=word_tokenize, ngram_range=(1, 2))
try:
    tfidf_matrix = vectorizer.fit_transform(df['search_text'])
except:
    print("‚ö†Ô∏è AI Init Failed")

# --- 2. ‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Route: /predict) ---
@app.route('/predict', methods=['POST'])
def analyze():
    # üî• 1. ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å API Key (‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Å‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ)
    # ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ # ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å
    # if request.headers.get("x-api-key") != os.getenv("API_KEY", "123456"):
    #     return jsonify({"success": False, "message": "Wrong Key"}), 401

    try:
        # ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        user_input = ""
        if request.is_json:
            user_input = request.json.get('symptoms', "")
        else:
            user_input = request.form.get('symptoms', "")
            
        print(f"üì© ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ß‡πà‡∏≤: {user_input}")

        if not user_input:
            return jsonify({"success": False, "prediction": "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"})

        # ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        user_vec = vectorizer.transform([user_input])
        scores = cosine_similarity(user_vec, tfidf_matrix).flatten()
        top_idx = scores.argsort()[::-1][0] # ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 1 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
        
        # üî• ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≥‡∏•‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏à‡∏≠‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
        if scores[top_idx] > 0.01: 
            row = df.iloc[top_idx]
            return jsonify({
                "success": True,
                "prediction": str(row['‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ']),
                "confidence": float(scores[top_idx]),
                "treatment": str(row.get('‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏ï‡πâ‡∏ô', '-')),
                "herbs": str(row.get('‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á', '-')).split(',')
            })
        else:
            return jsonify({
                "success": True, 
                "prediction": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)"
            })

    except Exception as e:
        print(f"‚ùå Error: {e}")
        return jsonify({"success": False, "prediction": "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà Server"})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 5001)))