<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkinHerb Care - Admin Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Kanit', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Patterns */
        .pattern-leaf {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .pattern-germ {
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }
        .profile-drawer {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100%;
            background: rgba(255,255,255,0.95);
            box-shadow: -8px 0 24px rgba(0,0,0,0.1);
            transition: right 0.25s ease;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(8px);
        }
        .profile-drawer.open { right: 0; }
        .profile-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 900;
        }
        .profile-backdrop.show { opacity: 1; pointer-events: auto; }
        .profile-drawer-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #a7f3d0;
            background: #ecfdf5;
        }
        .profile-drawer-btn {
            width: 100%;
            border: none;
            border-radius: 10px;
            padding: 10px 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .profile-drawer-btn.primary { background: #34d399; color: #064e3b; }
        .profile-drawer-btn.ghost { background: #e5e7eb; color: #374151; }
    </style>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            const user = JSON.parse(userStr || '{}');
            
            if (user.role !== 'admin') {
                window.location.href = '/index.html'; // ‡∏´‡∏£‡∏∑‡∏≠ user-dashboard
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ Admin ‡πÉ‡∏ô Sidebar
            const adminNameElements = document.querySelectorAll('.admin-name-display');
            adminNameElements.forEach(el => {
                if (user.firstName) {
                    el.textContent = `${user.firstName} ${user.lastName || ''}`;
                }
            });
        });
    </script>
</head>
<body class="bg-[#F4F7FE] text-gray-800 flex h-screen overflow-hidden">

    <aside class="w-64 bg-[#111C44] text-white flex flex-col flex-shrink-0 transition-all duration-300 shadow-xl z-20">
        
        <div class="p-6 flex items-center justify-center border-b border-gray-700/30">
            <div class="text-xl font-bold tracking-wide flex items-center gap-2">
                <i class="fa-solid fa-leaf text-green-400"></i> SKINHERB<span class="font-light">CARE</span>
            </div>
        </div>

        <div class="flex flex-col items-center mt-8 mb-6">
            <button id="profile-btn-admin" class="w-20 h-20 rounded-full border-2 border-yellow-400 p-1 overflow-hidden bg-white/10">
                <img id="profile-sidebar-img" src="" class="w-full h-full object-cover admin-sidebar-img" style="display:none;">
                <div id="profile-sidebar-fallback" class="w-full h-full flex items-center justify-center text-3xl">üë§</div>
            </button>
            <h3 id="profile-sidebar-name" class="mt-3 text-lg font-medium admin-sidebar-name">Admin</h3>
            <p class="text-xs text-gray-400 bg-white/10 px-2 py-0.5 rounded-full mt-1">Admin</p>
        </div>

        <nav class="flex-1 px-4 space-y-3 overflow-y-auto">
            <div class="text-[10px] text-gray-400 uppercase font-semibold pl-3 mb-2 tracking-wider">FEATURES</div>
            
            <a href="admin-dashboard.html" class="flex items-center gap-3 px-4 py-3 bg-[#FFC107] text-[#111C44] rounded-xl font-semibold transition-all">
                <i class="fa-solid fa-table-columns w-5 text-center"></i>
                <span>Dashboard</span>
            </a>

            <a href="herb_list.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/10 rounded-xl transition-all hover:pl-6">
                <i class="fa-solid fa-leaf w-5 text-center text-green-400"></i>
                <span>‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£</span>
            </a>

            <a href="disease_list.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/10 rounded-xl transition-all hover:pl-6">
                <i class="fa-solid fa-virus w-5 text-center text-cyan-400"></i>
                <span>‡πÇ‡∏£‡∏Ñ‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á</span>
            </a>
        </nav>

        <div class="p-4 mt-auto space-y-3 bg-[#0d1636]">
            
            <a href="index.html" class="w-full bg-[#1A2B5F] hover:bg-[#233a7d] text-white py-3 rounded-xl flex items-center justify-center gap-2 transition-all border border-gray-600/50 shadow-sm">
                <i class="fa-solid fa-globe"></i>
                <span>‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</span>
            </a>

            <button id="logout-btn" onclick="logout()" class="w-full bg-[#FF0000] hover:bg-red-700 text-white py-3 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg">
                <i class="fa-solid fa-power-off"></i>
                <span>Log Out</span>
            </button>

        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-y-auto">
        
        <header class="flex justify-between items-center p-6 bg-[#F4F7FE]">
            <div class="flex items-center gap-4">
                <button class="text-[#111C44] text-2xl lg:hidden"><i class="fa-solid fa-bars"></i></button>
                
                <div>
                    <div class="text-sm text-gray-500">Pages / Dashboard</div>
                    <h1 class="text-2xl font-bold text-[#111C44]">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h1>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="hidden md:block text-right">
                   <p class="text-sm text-gray-600">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö,</p>
                   <p class="font-bold text-[#111C44] admin-name-display">Loading...</p>
                </div>

                <!-- Admin quick search -->
                <div class="hidden sm:flex items-center gap-2">
                    <input id="admin-search-input" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="px-3 py-2 rounded-lg border border-gray-200">
                    <button id="admin-search-btn" class="bg-green-600 text-white px-3 py-2 rounded-lg">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
            </div> 
        </header>

        <div class="px-6 pb-6">
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6 mb-6">
                
                <div class="lg:col-span-5 flex flex-col gap-6">
                    <a href="herb_list.html" class="block bg-gradient-to-r from-[#4ADE80] to-[#22C55E] rounded-2xl p-6 text-white shadow-lg relative overflow-hidden pattern-leaf h-48 flex flex-col items-center justify-center text-center group cursor-pointer hover:shadow-xl transition-all">
                        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-leaf text-6xl"></i></div>
                        <h3 class="text-xl font-medium mb-1">‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <div id="total-products" class="text-6xl font-bold my-2 group-hover:scale-110 transition-transform">-</div>
                        <p class="text-lg opacity-90">‡∏ä‡∏ô‡∏¥‡∏î</p>
                    </a>

                    <div class="bg-gradient-to-r from-[#22d3ee] to-[#06b6d4] rounded-2xl p-6 text-white shadow-lg relative overflow-hidden pattern-germ h-48 flex flex-col items-center justify-center text-center group cursor-pointer hover:shadow-xl transition-all">
                        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-bacteria text-6xl"></i></div>
                        <h3 class="text-xl font-medium mb-1">‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                         <div id="total-diseases" class="text-6xl font-bold my-2 group-hover:scale-110 transition-transform">-</div>
                        <p class="text-lg opacity-90">‡∏ä‡∏ô‡∏¥‡∏î</p>
                    </div>
                </div>

                <div class="lg:col-span-7">
                    <div class="bg-[#111C44] rounded-2xl p-8 h-full min-h-[400px] relative overflow-hidden flex items-center shadow-lg">
                        <div class="absolute top-10 left-10 border-l-2 border-dashed border-white/30 h-20 w-20 rotate-45"></div>
                        
                        <div class="relative z-10 max-w-xs">
                            <h2 class="text-4xl font-bold text-white leading-tight mb-2">Work Life <br> <span class="text-[#FFC107]">Balance</span></h2>
                            <p class="text-gray-400 text-sm mt-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                            
                            <div class="mt-8">
                                <i class="fa-regular fa-paper-plane text-white/50 text-4xl transform rotate-12"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="disease-section" class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-[#111C44]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ (Disease Management)</h2>
                    <a href="add_disease.html" class="bg-[#2B3674] hover:bg-blue-900 text-white px-5 py-2 rounded-lg flex items-center gap-2 shadow-md transition-colors inline-flex">
                        <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà
                    </a>
                </div>

                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-[#111C44] text-sm uppercase font-semibold">
                                    <th class="p-4 border-b">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                                    <th class="p-4 border-b">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ</th>
                                    <th class="p-4 border-b">‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</th>
                                    <th class="p-4 border-b text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="disease-table-body" class="text-sm text-gray-600">
                                <tr>
                                    <td colspan="4" class="p-8 text-center text-gray-400">
                                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API)
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
        </div>
    </main>

    <div id="profile-backdrop" class="profile-backdrop"></div>
    <aside id="profile-drawer" class="profile-drawer" aria-hidden="true">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-[#0f3d2e]">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
            <button id="profile-close" class="profile-drawer-btn ghost" style="width:auto;padding:6px 10px;">‡∏õ‡∏¥‡∏î</button>
        </div>
        <div class="flex flex-col items-start gap-2">
            <img id="profile-drawer-img" class="profile-drawer-avatar" src="" alt="Profile" style="display:none;">
            <div id="profile-drawer-fallback" class="profile-drawer-avatar flex items-center justify-center text-2xl text-green-500">üë§</div>
            <div id="profile-drawer-name" class="font-bold text-[#0f3d2e]">Admin</div>
            <div id="profile-drawer-email" class="text-sm text-gray-500">-</div>
        </div>
        <div class="mt-4 grid gap-2">
            <label class="profile-drawer-btn ghost text-center" for="profile-image-input">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
            <input id="profile-image-input" type="file" accept="image/*" style="display:none;">
            <button id="profile-logout" class="profile-drawer-btn primary">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </aside>

    <script src="/js/main.js?v=20260208"></script> 
    <script src="/js/profile-drawer.js?v=20260208"></script>
    <script>
        function logout() {
            if (confirm('‚ùì ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('userRole');
                window.location.href = '/login.html';
            }
        }

        // Admin quick search - navigate to herb list with optional query
        const API_BASE_URL = window.location.hostname.includes('netlify.app')
            ? 'https://skinherbcareweb1.onrender.com'
            : window.location.origin;

        document.addEventListener('DOMContentLoaded', () => {
            const adminSearchBtn = document.getElementById('admin-search-btn');
            if (adminSearchBtn) {
                adminSearchBtn.addEventListener('click', () => {
                    const q = document.getElementById('admin-search-input').value.trim();
                    window.location.href = `/herb_list.html${q ? '?q=' + encodeURIComponent(q) : ''}`;
                });
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API (‡πÅ‡∏™‡∏î‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
            (async function loadAdminStats() {
                const token = localStorage.getItem('token') || localStorage.getItem('userToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                try {
                    const [herbRes, diseaseRes] = await Promise.all([
                        fetch(`${API_BASE_URL}/api/herbs/admin`, { headers }),
                        fetch(`${API_BASE_URL}/api/diseases/admin`, { headers })
                    ]);

                    const herbJson = herbRes.ok ? await herbRes.json() : null;
                    const diseaseJson = diseaseRes.ok ? await diseaseRes.json() : null;

                    const herbs = herbJson ? (herbJson.herbs || herbJson.data || []) : [];
                    const diseases = diseaseJson ? (diseaseJson.diseases || diseaseJson.data || []) : [];

                    const totalHerbEl = document.getElementById('total-products');
                    const totalDiseaseEl = document.getElementById('total-diseases');
                    if (totalHerbEl) totalHerbEl.textContent = herbs.length;
                    if (totalDiseaseEl) totalDiseaseEl.textContent = diseases.length;

                    const tableBody = document.getElementById('disease-table-body');
                    if (tableBody) {
                        tableBody.innerHTML = '';
                        const latest = diseases.slice(0, 6);
                        if (latest.length === 0) {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="4" class="p-8 text-center text-gray-400">
                                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ
                                    </td>
                                </tr>
                            `;
                        } else {
                            latest.forEach((d) => {
                                const published = d.published === true;
                                const status = published ? '‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà';
                                const statusClass = published ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600';
                                const tr = document.createElement('tr');
                                tr.className = 'border-b last:border-none';
                                tr.innerHTML = `
                                    <td class="p-4">
                                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600">
                                            <i class="fa-solid fa-disease"></i>
                                        </div>
                                    </td>
                                    <td class="p-4 font-bold text-[#111C44]">${d.name || '-'}</td>
                                    <td class="p-4">
                                        <span class="${statusClass} px-2 py-1 rounded text-xs font-bold">${status}</span>
                                    </td>
                                    <td class="p-4 text-center space-x-2">
                                        <a href="disease_list.html" class="text-blue-500 hover:text-blue-600 text-sm font-semibold">‡πÑ‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</a>
                                    </td>
                                `;
                                tableBody.appendChild(tr);
                            });
                        }
                    }
                } catch (err) {
                    console.error('Failed to load admin stats', err);
                }
            })();

            // ‡πÄ‡∏ä‡πá‡∏Ñ /status ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤ env ‡∏ö‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏≤‡∏î
            (async function checkServerStatus() {
                try {
                    const res = await fetch(`${API_BASE_URL}/status`);
                    const j = await res.json().catch(() => null);
                    if (j && Array.isArray(j.missing_envs) && j.missing_envs.length > 0) {
                        alert('‚ö†Ô∏è Server configuration missing: ' + j.missing_envs.join(', ') + '\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ environment variables ‡∏ö‡∏ô hosting (Render)');
                    }
                } catch (err) {
                    console.error('Status check failed', err);
                }
            })();
        });

        (function setupProfilePanel() {
            const token = localStorage.getItem('token');
            const userRaw = localStorage.getItem('user');
            const user = userRaw ? JSON.parse(userRaw) : null;

            const btn = document.getElementById('profile-btn-admin');
            const drawer = document.getElementById('profile-drawer');
            const backdrop = document.getElementById('profile-backdrop');
            const closeBtn = document.getElementById('profile-close');
            const logoutBtn = document.getElementById('profile-logout');
            const nameSidebar = document.getElementById('profile-sidebar-name');
            const nameDrawer = document.getElementById('profile-drawer-name');
            const emailDrawer = document.getElementById('profile-drawer-email');
            const imgSidebar = document.getElementById('profile-sidebar-img');
            const fallbackSidebar = document.getElementById('profile-sidebar-fallback');
            const imgDrawer = document.getElementById('profile-drawer-img');
            const fallbackDrawer = document.getElementById('profile-drawer-fallback');
            const imageInput = document.getElementById('profile-image-input');

            const fullName = user
                ? [user.firstName, user.lastName].filter(Boolean).join(' ') || user.name || user.username || 'Admin'
                : 'Admin';
            const email = user && user.email ? user.email : '-';
            if (nameSidebar) nameSidebar.textContent = fullName;
            if (nameDrawer) nameDrawer.textContent = fullName;
            if (emailDrawer) emailDrawer.textContent = email;

            const storageKey = email && email !== '-' ? `profileImage:${email}` : 'profileImage:guest';

            const applyImage = (src) => {
                if (src) {
                    imgSidebar.src = src;
                    imgSidebar.style.display = 'block';
                    fallbackSidebar.style.display = 'none';
                    imgDrawer.src = src;
                    imgDrawer.style.display = 'block';
                    fallbackDrawer.style.display = 'none';
                } else {
                    imgSidebar.style.display = 'none';
                    fallbackSidebar.style.display = 'flex';
                    imgDrawer.style.display = 'none';
                    fallbackDrawer.style.display = 'flex';
                }
            };
            const legacyImage = localStorage.getItem('profileImage');
            if (!localStorage.getItem(storageKey) && legacyImage) {
                localStorage.setItem(storageKey, legacyImage);
            }
            applyImage(localStorage.getItem(storageKey));

            const openDrawer = () => {
                if (!token) { window.location.href = '/login.html'; return; }
                drawer.classList.add('open');
                backdrop.classList.add('show');
                drawer.setAttribute('aria-hidden', 'false');
            };
            const closeDrawer = () => {
                drawer.classList.remove('open');
                backdrop.classList.remove('show');
                drawer.setAttribute('aria-hidden', 'true');
            };

            if (btn) btn.addEventListener('click', openDrawer);
            if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
            if (backdrop) backdrop.addEventListener('click', closeDrawer);
            if (logoutBtn) logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('userRole');
                window.location.href = '/login.html';
            });
            if (imageInput) {
                imageInput.addEventListener('change', () => {
                    const file = imageInput.files && imageInput.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const src = e.target.result;
                        localStorage.setItem(storageKey, src);
                        localStorage.setItem('profileImage', src);
                        applyImage(src);
                    };
                    reader.readAsDataURL(file);
                });
            }
        })();
    </script>
</body>
</html>
